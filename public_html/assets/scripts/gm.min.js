document.addEventListener("DOMContentLoaded",(function(){const e={language:document.getElementById("mcqblust-screen-language"),mode:document.getElementById("mcqblust-screen-mode"),singleSetup:document.getElementById("mcqblust-screen-single-setup"),loading:document.getElementById("mcqblust-screen-loading"),game:document.getElementById("mcqblust-screen-game"),results:document.getElementById("mcqblust-screen-results")};let t={},n=null,s=null;const o=t=>{Object.values(e).forEach((e=>{e&&e.classList.add("hidden")})),e[t]&&e[t].classList.remove("hidden")},r=()=>{t={language:"",mode:"",settings:{},questions:[],userAnswers:[],currentQuestionIndex:0,score:0},n=null,clearInterval(s)};[document.getElementById("mcqblust-single-grade"),document.getElementById("mcqblust-multi-grade")].forEach((e=>{if(e)for(let t=1;t<=13;t++)e.add(new Option(`Grade ${t}`,t))}));const a=()=>{if(e.game&&!e.game.classList.contains("hidden"))return;const t=document.getElementById("mcqblust-lightbox"),n=document.getElementById("mcqblust-container");n&&t&&(n.style.opacity="0",n.style.transform="scale(0.95)",setTimeout((()=>{t.classList.add("hidden"),window.history.pushState({},document.title,window.location.pathname)}),300))},l=document.getElementById("mcqblust-gameyard-icon");l&&l.addEventListener("click",(()=>{r(),(()=>{const e=document.getElementById("mcqblust-lightbox"),t=document.getElementById("mcqblust-container");e&&t&&(e.classList.remove("hidden"),t.style.opacity="1",t.style.transform="scale(1)")})(),o("language")}));const c=document.getElementById("mcqblust-close-btn");c?c.addEventListener("click",(e=>{e.preventDefault(),a()})):console.warn("Close button not found: #mcqblust-close-btn"),document.querySelectorAll(".mcqblust-lang-btn").forEach((e=>e.addEventListener("click",(function(){t.language=e.dataset.lang,o("mode")})))),document.querySelectorAll(".mcqblust-back-btn").forEach((e=>e.addEventListener("click",(e=>o(e.currentTarget.dataset.target)))));const i=document.getElementById("mcqblust-btn-single-player");i&&i.addEventListener("click",(()=>o("singleSetup")));const u=document.getElementById("mcqblust-btn-back-to-main");u?u.addEventListener("click",a):console.warn("Back to main button not found: #mcqblust-btn-back-to-main"),["single"].forEach((e=>{const t=document.getElementById(`mcqblust-${e}-mcqs`),n=document.getElementById(`mcqblust-${e}-mcq-count-label`);t&&n&&t.addEventListener("input",(e=>{n.textContent=e.target.value}))}));const d=document.getElementById("mcqblust-form-single-player");function m(){const e=t.questions[t.currentQuestionIndex];if(!e)return;document.getElementById("mcqblust-current-q-num").textContent=t.currentQuestionIndex+1,document.getElementById("mcqblust-total-q-num").textContent=t.questions.length,document.getElementById("mcqblust-question-text").textContent=e.question;const n=document.getElementById("mcqblust-options-container");n.innerHTML="",e.options.forEach((e=>{const s=document.createElement("button");s.className="option-btn",s.textContent=e,t.userAnswers[t.currentQuestionIndex]===e&&s.classList.add("selected"),s.addEventListener("click",(()=>function(e,n){t.userAnswers[t.currentQuestionIndex]=e,document.querySelectorAll(".option-btn").forEach((e=>e.classList.remove("selected"))),n.classList.add("selected")}(e,s))),n.appendChild(s)})),E()}d&&d.addEventListener("submit",(async e=>{if(e.preventDefault(),t.mode="single",t.settings={subject:document.getElementById("mcqblust-single-subject").value,grade:document.getElementById("mcqblust-single-grade").value,term:document.getElementById("mcqblust-single-term").value,timer:document.getElementById("mcqblust-single-timer").value,focus:document.getElementById("mcqblust-single-focus").value,mcqs:document.getElementById("mcqblust-single-mcqs").value},!t.language){const e=document.querySelector(".mcqblust-lang-btn.selected");t.language=e?e.dataset.lang:"en"}o("loading"),await async function(){const{language:e,settings:s}=t,{subject:o,grade:r,term:a,focus:l,mcqs:c}=s;let i=null;try{const s=await fetch("https://apilageai.lk/generate_questions.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({language:e,subject:o,grade:r,term:a,focus:l,mcqs:c})}),u=await s.text();if(!u||""===u.trim())return console.error("generate_questions.php returned empty response"),alert("Failed to generate questions (empty response). Please try again."),void(t.questions=[]);let d;try{d=JSON.parse(u)}catch(e){return console.error("Non-JSON response from generate_questions.php:",u),alert("Failed to generate questions (invalid server response). Please try again."),void(t.questions=[])}if(!d.success||!d.game_id)return console.error("generate_questions.php returned error or missing game_id:",d),alert("Failed to generate questions. Please try again."),void(t.questions=[]);i=d.game_id,n=i;const m=await fetch(`https://apilageai.lk/get_questions.php?game_id=${encodeURIComponent(i)}`),g=await m.text();if(!g||""===g.trim())return console.error("get_questions.php returned empty response"),alert("Failed to fetch generated questions (empty response). Please try again."),void(t.questions=[]);let p;try{p=JSON.parse(g)}catch(e){return console.error("Non-JSON response from get_questions.php:",g),alert("Failed to fetch generated questions (invalid server response). Please try again."),void(t.questions=[])}if(!p.success||!Array.isArray(p.questions))return console.error("get_questions.php returned error or missing questions:",p),alert("Failed to fetch generated questions. Please try again."),void(t.questions=[]);t.questions=p.questions}catch(e){console.error("Question Generation Error:",e),alert("Failed to generate questions due to a network or server error. Please try again."),t.questions=[]}}(),t.questions&&t.questions.length>0?(t.currentQuestionIndex=0,t.userAnswers=new Array(t.questions.length).fill(null),o("game"),m(),"single"===t.mode&&t.settings.timer>0&&function(e){let t=e;const n=document.getElementById("mcqblust-game-timer");n.style.display="block",s=setInterval((()=>{const e=Math.floor(t/60);let o=t%60;n.textContent=`${e}:${o<10?"0":""}${o}`,--t<0&&(clearInterval(s),n.textContent="Time's Up!")}),1e3)}(60*t.settings.timer)):(alert("Failed to generate questions. Please try again."),o("singleSetup"))}));const g=e=>{const n=t.currentQuestionIndex+e;n>=0&&n<t.questions.length&&(t.currentQuestionIndex=n,m())},p=document.getElementById("mcqblust-btn-next"),q=document.getElementById("mcqblust-btn-prev"),y=document.getElementById("mcqblust-btn-skip"),b=document.getElementById("mcqblust-btn-submit");function E(){p&&q&&b&&(q.disabled=0===t.currentQuestionIndex,t.currentQuestionIndex===t.questions.length-1?(p.classList.add("hidden"),b.classList.remove("hidden")):(p.classList.remove("hidden"),b.classList.add("hidden")))}p&&p.addEventListener("click",(()=>{g(1),E()})),q&&q.addEventListener("click",(()=>{g(-1),E()})),y&&y.addEventListener("click",(()=>{g(1),E()})),b&&b.addEventListener("click",(async()=>{await async function(){let e=0;try{const s=await fetch("https://apilageai.lk/submit_answer.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({game_id:n,answers:t.userAnswers})});if(!(await s.json()).success)throw new Error("Failed to submit answers");const o=await fetch(`https://apilageai.lk/get_results.php?game_id=${encodeURIComponent(n)}`),r=await o.json();if(!r.success)throw new Error("Failed to fetch results");e=r.score}catch(n){e=function(e,t){let n=0;return t&&Array.isArray(t)?(e.forEach(((e,s)=>{const o="number"==typeof e.mark?e.mark:1;t[s]===e.answer?n+=o:t[s]&&t[s]!==e.answer&&(n-=o)})),n):0}(t.questions,t.userAnswers)}document.getElementById("mcqblust-final-score").textContent=e;const s=t.questions.reduce(((e,t)=>e+("number"==typeof t.mark?t.mark:1)),0);document.getElementById("mcqblust-total-score").textContent=s,document.getElementById("mcqblust-results-summary").innerHTML=function(e,t){let n='<div class="space-y-4">';return e.forEach(((e,s)=>{const o=t[s],r=o===e.answer,a=r?"result-card-correct":"result-card-incorrect",l=e.options.map((t=>{let n="";return t===e.answer?n="result-option-correct":t!==o||r||(n="result-option-incorrect"),`<div class="result-option ${n}">${t}</div>`})).join("");n+=`\n                    <div class="result-card ${a}">\n                        <p style="font-weight: 600; margin-bottom: 0.5rem;">${s+1}. ${e.question}</p>\n                        <div style="font-size: 0.875rem;">${l}</div>\n                        <p style="margin-top: 0.5rem; font-size: 0.875rem;">Correct answer: <span style="font-weight: 600;">${e.answer}</span></p>\n                        <p class="explanation"><strong>Explanation:</strong> ${e.explanation}</p>\n                        <p style="font-size: 0.85rem; margin-top:0.25rem;">Mark: ${e.mark||1}</p>\n                    </div>\n                `})),n+="</div>",n}(t.questions,t.userAnswers),o("results")}()}));const f=document.getElementById("mcqblust-btn-play-again");f?f.addEventListener("click",(()=>{r(),o("language")})):console.warn("Play Again button not found: #mcqblust-btn-play-again")}));