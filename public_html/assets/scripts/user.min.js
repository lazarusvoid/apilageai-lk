document.addEventListener("DOMContentLoaded", function () {
  const accountMgr = document.getElementById("accountmgr");
  const blurOverlay = document.getElementById("blurOverlay");
  const closeBtn = document.getElementById("closeAccountMgr");
  const sidebarItems = accountMgr.querySelectorAll(".accountmgr-sidebar li");
  const sections = accountMgr.querySelectorAll(".accountmgr-section");

  // Close Lightbox
  function closeLightbox() {
    accountMgr.style.display = "none";
    blurOverlay.style.display = "none";
  }

  closeBtn.addEventListener("click", closeLightbox);
  blurOverlay.addEventListener("click", closeLightbox);

  // Sidebar navigation
  sidebarItems.forEach((item) => {
    item.addEventListener("click", function () {
      sidebarItems.forEach((li) => li.classList.remove("active"));
      sections.forEach((sec) => sec.classList.remove("active"));

      this.classList.add("active");
      const target = this.dataset.section;
      document.getElementById("accountmgr-section-" + target).classList.add("active");
    });
  });

  /* ---------------- BASIC FORM ---------------- */
  const basicForm = document.getElementById("basicInfoForm");
  if (basicForm) {
    basicForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(basicForm);

      fetch("backend/update_basic.php", {
        method: "POST",
        body: formData,
        credentials: "include"
      })
      .then((res) => res.json())
      .then((data) => {
        alert(data.message || "Profile updated successfully!");
      })
      .catch(() => alert("Error updating profile."));
    });
  }

  /* ---------------- AI PREFERENCES ---------------- */
  const clearMemoryBtn = document.getElementById("clearMemoryBtn");
  if (clearMemoryBtn) {
    clearMemoryBtn.addEventListener("click", () => {
      fetch("backend/clear_memory.php", { method: "POST", credentials: "include" })
        .then((res) => res.json())
        .then((data) => alert(data.message || "Memory cleared."))
        .catch(() => alert("Error clearing memory."));
    });
  }

  const updateInstructionBtn = document.getElementById("updateInstructionBtn");
  if (updateInstructionBtn) {
    updateInstructionBtn.addEventListener("click", () => {
      const instructions = document.getElementById("manualInstructions").value;
      fetch("backend/update_instructions.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "instructions=" + encodeURIComponent(instructions),
        credentials: "include"
      })
      .then((res) => res.json())
      .then((data) => alert(data.message || "Instructions updated."))
      .catch(() => alert("Error updating instructions."));
    });
  }

  const aiBehaviorSelect = document.getElementById("aiBehavior");
  if (aiBehaviorSelect) {
    aiBehaviorSelect.addEventListener("change", () => {
      const behavior = aiBehaviorSelect.value;
      fetch("backend/update_behavior.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "behavior=" + encodeURIComponent(behavior),
        credentials: "include"
      })
      .then((res) => res.json())
      .then((data) => console.log(data.message || "Behavior updated."))
      .catch(() => alert("Error updating behavior."));
    });
  }

  /* ---------------- BILLING ---------------- */
  const rechargeSlider = document.getElementById("rechargeAmount");
  const rechargeValue = document.getElementById("rechargeValue");
  const rechargeButton = document.getElementById("rechargeButton");

  if (rechargeSlider && rechargeValue && rechargeButton) {
    rechargeSlider.addEventListener("input", () => {
      rechargeValue.textContent = rechargeSlider.value;
      rechargeButton.href = "https://apilageai.lk/pay/" + rechargeSlider.value;
    });
  }

  // Populate billing table (example fetch â€“ adjust backend path)
  const billingTable = document.getElementById("billingTable");
  if (billingTable) {
    fetch("backend/get_billing.php", { credentials: "include" })
      .then((res) => res.json())
      .then((rows) => {
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row.date}</td><td>${row.amount}</td><td>${row.status}</td>`;
          billingTable.appendChild(tr);
        });
      })
      .catch(() => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3">No billing history available.</td>`;
        billingTable.appendChild(tr);
      });
  }

  /* ---------------- ADVANCED ---------------- */
  const deleteAccountBtn = document.getElementById("deleteAccountBtn");
  if (deleteAccountBtn) {
    deleteAccountBtn.addEventListener("click", () => {
      if (!confirm("Are you sure you want to delete your account? This action cannot be undone.")) return;

      fetch("backend/delete_account.php", { method: "POST", credentials: "include" })
        .then((res) => res.json())
        .then((data) => {
          alert(data.message || "Account deleted.");
          if (data.success) window.location.href = "/auth/signout";
        })
        .catch(() => alert("Error deleting account."));
    });
  }
});
