document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("mindmap-open-btn"),t=document.getElementById("mindmap-close-btn"),n=document.getElementById("mindmap-lightbox"),o=document.getElementById("mindmap-go-btn"),i=document.getElementById("mindmap-develop-btn"),s=document.getElementById("mindmap-input"),d=document.getElementById("mindmap-develop-input"),l=document.getElementById("mindmap-right-panel"),c=document.getElementById("mindmap-visualizer"),a=document.getElementById("mindmap-canvas"),r=document.getElementById("mindmap-loader"),u=document.getElementById("fullscreen-btn"),m=document.getElementById("save-png-btn"),p=document.getElementById("add-node-btn"),f=document.getElementById("add-text-btn"),h=document.getElementById("connect-node-btn"),y=document.getElementById("zoom-in-btn"),v=document.getElementById("zoom-out-btn"),g=document.getElementById("context-menu"),E=document.getElementById("ctx-add-subnodes");let x=null,L=new Map,b=null,I=null,$=!1,k={x:0,y:0},w={x:0,y:0},C=1,M=!1,B=null,A=null,T=null;e.addEventListener("click",(e=>{e.preventDefault(),n.classList.add("visible")})),t.addEventListener("click",(()=>n.classList.remove("visible")));async function N(e,t){try{const n=await fetch("https://apilageai.lk/api/mindmap.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:e,...t})});if(!n.ok)throw new Error(`API Error: ${n.status} ${n.statusText}`);const o=await n.json();if(!o.success||!o.data)throw new Error(o.error||"API returned unsuccessful response");{let e=o.data;if("string"==typeof e){e=e.replace(/``````/gi,"").trim();const t=e.indexOf("{"),n=e.lastIndexOf("}"),o=e.indexOf("["),i=e.lastIndexOf("]");if(-1!==o&&o<t){const t=e.slice(o,i+1);return JSON.parse(t)}if(-1!==t&&-1!==n){const o=e.slice(t,n+1);return JSON.parse(o)}throw new Error("Valid JSON not found in API response.")}if("object"==typeof e)return e}}catch(e){return console.error("Error calling API:",e),alert(`API call failed: ${e.message}. Using local simulation as a fallback.`),function(e){const t=[...new Set(e.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(/\s+/))].filter((e=>e.length>2));if(0===t.length)return{id:"root-empty",topic:"No Text",children:[]};const n=t.length>1?t.slice(0,2).join(" "):t[0];let o=t.slice(2);const i={id:"root",topic:n,note:"This is the central theme.",children:[]};for(let e=0;e<Math.min(4,o.length);e++){const t={id:`b${e}`,topic:o[e],note:`A key concept related to ${n}.`,children:[]};i.children.push(t)}return i.children.forEach(((e,t)=>{const n=o.slice(4+3*t);n.length>0&&e.children.push({id:`${e.id}-1`,topic:n[0],note:`Detail about ${e.topic}.`,children:[n.length>2?{id:`${e.id}-1-1`,topic:n[2],note:"Sub-detail."}:null].filter((e=>e))}),n.length>1&&e.children.push({id:`${e.id}-2`,topic:n[1],note:`More detail about ${e.topic}.`})})),i}(s.value)}}async function P(e){r.style.display="flex",a.innerHTML="",I&&I.remove(),L.clear(),w={x:0,y:0},C=1,W();const t=await e();b=t,t&&t.id?S(t):alert("Could not generate a valid mind map structure."),r.style.display="none"}function S(e){I=document.createElementNS("http://www.w3.org/2000/svg","svg"),I.style.position="absolute",I.style.width="100%",I.style.height="100%",I.style.top="0",I.style.left="0",I.style.pointerEvents="none",a.appendChild(I);const t=function(e){const t=[],n=[];let o=0;function i(e,s,d,l){if(!e||!e.id)return;const c=1===d?o++%4:l,a={id:e.id,topic:e.topic,note:e.note,level:d,parentId:s?s.id:null,parentColorIndex:c,children:[]};if(t.push(a),s){n.push({childId:e.id,parentId:s.id});const o=t.find((e=>e.id===s.id));o&&o.children.push(a)}e.children&&Array.isArray(e.children)&&e.children.forEach((t=>i(t,e,d+1,c)))}return i(e,null,0,-1),{nodes:t,relationships:n}}(e);t.nodes.forEach((e=>{D(e)})),function(e){const{width:t,height:n}=a.getBoundingClientRect(),o=t/2,i=n/2,s=e.nodes.find((e=>0===e.level));if(s){const e=L.get(s.id).el;s.x=o,s.y=i,e.style.left=o-e.offsetWidth/2+"px",e.style.top=i-e.offsetHeight/2+"px"}const d={};e.relationships.forEach((t=>{d[t.parentId]||(d[t.parentId]=[]);const n=e.nodes.find((e=>e.id===t.childId));n&&d[t.parentId].push(n)})),Object.keys(d).forEach((t=>{const n=d[t],s=e.nodes.find((e=>e.id===t));if(!s)return;void 0!==s.x&&void 0!==s.y||(s.x=o,s.y=i);const l=s.x,c=s.y,a=180+120*n[0].level,r=2*Math.PI/n.length;n.forEach(((e,t)=>{const n=t*r-Math.PI/2;e.x=l+Math.cos(n)*a,e.y=c+Math.sin(n)*a;const o=L.get(e.id).el;o&&(o.style.left=e.x-o.offsetWidth/2+"px",o.style.top=e.y-o.offsetHeight/2+"px")}))})),function(e,t){const n=100;for(let o=0;o<t;o++){let t=!1;for(let o=0;o<e.length;o++)for(let i=o+1;i<e.length;i++){const s=e[o],d=e[i];if(!(s.x&&s.y&&d.x&&d.y))continue;const l=d.x-s.x,c=d.y-s.y,a=Math.sqrt(l*l+c*c);if(a<n&&a>0){t=!0;const e=n-a,o=l/a*e*.5,i=c/a*e*.5;0!==s.level&&(s.x-=o,s.y-=i),0!==d.level&&(d.x+=o,d.y+=i)}}if(!t)break}}(e.nodes,5),e.nodes.forEach((e=>{const t=L.get(e.id).el;t&&void 0!==e.x&&void 0!==e.y&&(t.style.left=e.x-t.offsetWidth/2+"px",t.style.top=e.y-t.offsetHeight/2+"px")}))}(t),function(e){I.innerHTML="",e.relationships.forEach((e=>{const t=L.get(e.childId)?.el,n=L.get(e.parentId)?.el;t&&n?H(t,n,!1):console.warn(`Missing element for connection: ${e.childId} -> ${e.parentId}`)}))}(t)}function D(e){const t=document.createElement("div");t.id=`mindmap-node-${e.id}`,t.className="mindmap-node";const n=document.createElement("span");var o;n.textContent=e.topic,t.appendChild(n),t.dataset.id=e.id,0===e.level?t.classList.add("color-main"):t.classList.add(`color-${e.parentColorIndex}`),t.setAttribute("data-color-index",e.parentColorIndex),(o=n).parentElement.addEventListener("dblclick",(e=>{e.target!==o.parentElement&&e.target!==o||(o.setAttribute("contenteditable","true"),o.focus(),document.execCommand("selectAll",!1,null))})),o.addEventListener("blur",(()=>o.setAttribute("contenteditable","false"))),o.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),o.blur())})),Y(t);const i=document.createElement("div");i.className="node-actions";const s=document.createElement("div");s.className="node-action-btn info-node-btn",s.innerHTML='<i class="fa-solid fa-info"></i>';const d=document.createElement("div");d.className="node-action-btn delete-node-btn",d.innerHTML="&times;",i.appendChild(s),i.appendChild(d),t.appendChild(i);const l=document.createElement("div");l.className="node-note",l.textContent=e.note||"Click to add a note.",l.setAttribute("contenteditable","true"),t.appendChild(l),s.addEventListener("click",(e=>{e.stopPropagation(),l.style.display="block"===l.style.display?"none":"block"})),d.addEventListener("click",(e=>{e.stopPropagation(),function(e){const t=e.dataset.id;e.remove(),I.querySelectorAll(`[data-start-node*="${t}"], [data-end-node*="${t}"]`).forEach((e=>e.remove())),L.delete(t)}(t)})),a.appendChild(t),L.set(e.id,{el:t,data:e})}function H(e,t,n=!1){const o=document.createElementNS("http://www.w3.org/2000/svg","path");return o.setAttribute("class","mindmap-connector"),o.setAttribute("data-start-node",e.id),o.setAttribute("data-end-node",t.id),n&&o.setAttribute("data-manual","true"),I.prepend(o),O(o),o.addEventListener("click",(e=>{e.stopPropagation(),A&&A.classList.remove("selected"),A=o,o.classList.add("selected")})),o}function O(e){const t=document.getElementById(e.dataset.startNode),n=document.getElementById(e.dataset.endNode);if(!t||!n)return;const o=t.offsetLeft+t.offsetWidth/2,i=t.offsetTop+t.offsetHeight/2,s=n.offsetLeft+n.offsetWidth/2,d=n.offsetTop+n.offsetHeight/2,l=o+.5*(s-o),c=`M${o},${i} C${l},${i} ${l},${d} ${s},${d}`;e.setAttribute("d",c)}function X(e){const t=e.id;I.querySelectorAll(`[data-start-node="${t}"], [data-end-node="${t}"]`).forEach(O)}function Y(e,t=!0){e.addEventListener("mousedown",(n=>{if(n.target.isContentEditable||n.target.closest(".node-actions")||n.target.closest(".delete-text-btn"))return;if(n.preventDefault(),n.stopPropagation(),M&&t)return void(B?(B!==e&&H(e,B,!0),B.classList.remove("connection-start"),B=null,M=!1,l.classList.remove("connecting-mode"),h.classList.remove("active")):(B=e,e.classList.add("connection-start")));x=e;const o={x:x.offsetLeft,y:x.offsetTop},i={x:n.clientX,y:n.clientY};function s(e){if(!x)return;const n=(e.clientX-i.x)/C,s=(e.clientY-i.y)/C;x.style.left=`${o.x+n}px`,x.style.top=`${o.y+s}px`,t&&X(x)}document.addEventListener("mousemove",s),document.addEventListener("mouseup",(function(){x=null,document.removeEventListener("mousemove",s)}),{once:!0})})),e.addEventListener("touchstart",(n=>{if(n.target.isContentEditable||n.target.closest(".node-actions")||n.target.closest(".delete-text-btn"))return;if(n.touches.length>1)return;if(n.preventDefault(),n.stopPropagation(),M&&t)return void(B?(B!==e&&H(e,B,!0),B.classList.remove("connection-start"),B=null,M=!1,l.classList.remove("connecting-mode"),h.classList.remove("active")):(B=e,e.classList.add("connection-start")));x=e;const o={x:x.offsetLeft,y:x.offsetTop},i={x:n.touches[0].clientX,y:n.touches[0].clientY};function s(e){if(!x)return;if(!e.touches||0===e.touches.length)return;const n=(e.touches[0].clientX-i.x)/C,s=(e.touches[0].clientY-i.y)/C;x.style.left=`${o.x+n}px`,x.style.top=`${o.y+s}px`,t&&X(x)}document.addEventListener("touchmove",s,{passive:!1}),document.addEventListener("touchend",(function e(t){x=null,document.removeEventListener("touchmove",s),document.removeEventListener("touchend",e)}),{once:!0})}))}function W(){a.style.transform=`translate(${w.x}px, ${w.y}px) scale(${C})`}function j(){const e=c.getBoundingClientRect();let t=1/0,n=1/0,o=-1/0,i=-1/0;if(0===L.size)return;L.forEach((({el:e})=>{t=Math.min(t,e.offsetLeft),n=Math.min(n,e.offsetTop),o=Math.max(o,e.offsetLeft+e.offsetWidth),i=Math.max(i,e.offsetTop+e.offsetHeight)}));const s=o-t,d=i-n,l=t+s/2,a=n+d/2;C=.8*Math.min(e.width/s,e.height/d),w.x=e.width/2-l*C,w.y=e.height/2-a*C,W()}o.addEventListener("click",(async()=>{const e=s.value.trim();e?await P((()=>N("generate",{text:e}))):alert("Please enter some text to generate a mind map.")})),i.addEventListener("click",(async()=>{const e=d.value.trim();e&&b?await P((()=>N("develop",{instruction:e,currentMap:b}))):alert("Please generate a mind map first and provide an instruction.")})),E.addEventListener("click",(async()=>{if(!T)return;const e=L.get(T.dataset.id).data;r.style.display="flex";const t=await N("addSubnodes",{topic:e.topic});if(Array.isArray(t)){!function n(o){if(o.id===e.id)return o.children||(o.children=[]),o.children.push(...t),!0;if(o.children)for(const e of o.children)if(n(e))return!0;return!1}(b),S(b)}else alert("AI did not return valid sub-nodes.");r.style.display="none"})),p.addEventListener("click",(()=>{const{width:e,height:t}=a.getBoundingClientRect(),n={id:`manual-${Date.now()}`,topic:"New Topic",note:"Click to edit note.",level:1,parentColorIndex:Math.floor(4*Math.random())};D(n);const o=L.get(n.id).el;o.style.left=e/2-w.x/C-o.offsetWidth/2+"px",o.style.top=t/2-w.y/C-o.offsetHeight/2+"px"})),f.addEventListener("click",(()=>{const{width:e,height:t}=c.getBoundingClientRect(),n=document.createElement("div");n.className="manual-text-block",n.textContent="Editable text",n.setAttribute("contenteditable","true");const o=document.createElement("div");o.className="delete-text-btn",o.innerHTML="&times;",o.addEventListener("click",(()=>n.remove())),n.appendChild(o),n.style.left=e/2-w.x/C-75+"px",n.style.top=t/2-w.y/C-20+"px",a.appendChild(n),Y(n,!1)})),h.addEventListener("click",(()=>{M=!M,l.classList.toggle("connecting-mode",M),h.classList.toggle("active",M),!M&&B&&(B.classList.remove("connection-start"),B=null)})),u.addEventListener("click",(()=>{document.fullscreenElement?document.exitFullscreen():l.requestFullscreen().catch((e=>{alert(`Error attempting to enable full-screen mode: ${e.message} (${e.name})`)}))})),document.addEventListener("fullscreenchange",(()=>{document.fullscreenElement&&setTimeout(j,100)})),m.addEventListener("click",(()=>{const e=document.querySelectorAll(".node-actions, .help-text, .mindmap-toolbar, .delete-text-btn");e.forEach((e=>e.style.visibility="hidden")),html2canvas(a,{backgroundColor:null,scale:2}).then((t=>{const n=document.createElement("a");n.download="mindmap.png",n.href=t.toDataURL("image/png"),n.click(),e.forEach((e=>e.style.visibility="visible"))}))})),l.addEventListener("mousedown",(e=>{e.target!==l&&e.target!==c&&e.target!==a||(A&&(A.classList.remove("selected"),A=null),$=!0,k={x:e.clientX-w.x,y:e.clientY-w.y})})),l.addEventListener("touchstart",(e=>{e.target!==l&&e.target!==c&&e.target!==a||(A&&(A.classList.remove("selected"),A=null),!e.touches||e.touches.length>1||($=!0,k={x:e.touches[0].clientX-w.x,y:e.touches[0].clientY-w.y}))})),document.addEventListener("mousemove",(e=>{$&&(w.x=e.clientX-k.x,w.y=e.clientY-k.y,W())})),document.addEventListener("touchmove",(e=>{$&&e.touches&&1===e.touches.length&&(w.x=e.touches[0].clientX-k.x,w.y=e.touches[0].clientY-k.y,W())}),{passive:!1}),document.addEventListener("mouseup",(e=>{$=!1})),document.addEventListener("touchend",(e=>{$=!1})),y.addEventListener("click",(()=>{C=Math.min(2,C+.1),W()})),y.addEventListener("touchstart",(e=>{e.preventDefault(),C=Math.min(2,C+.1),W()}),{passive:!1}),v.addEventListener("click",(()=>{C=Math.max(.3,C-.1),W()})),v.addEventListener("touchstart",(e=>{e.preventDefault(),C=Math.max(.3,C-.1),W()}),{passive:!1}),"ontouchstart"in window||a.addEventListener("contextmenu",(e=>{e.preventDefault();const t=e.target.closest(".mindmap-node");t&&(T=t,g.style.display="block",g.style.left=`${e.clientX}px`,g.style.top=`${e.clientY}px`)})),document.addEventListener("click",(()=>{g.style.display="none",T=null})),document.addEventListener("keydown",(e=>{"Delete"!==e.key&&"Backspace"!==e.key||!A||(A.remove(),A=null)}))}));