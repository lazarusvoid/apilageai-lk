const micButton=document.getElementById("voicebox-micButton"),statusEl=document.getElementById("talk-status"),transcriptEl=document.getElementById("transcript"),assistantAudio=document.getElementById("assistant-audio");let pc=null,localStream=null,ephemeralKey=null,realtimeUrl="https://api.openai.com/v1/realtime";const backendUrl="https://talking-assitant.onrender.com";let micActive=!1;async function startCall(){micActive=!0;try{statusEl.textContent="සම්බන්ධ කරමින්...";const t=await fetch(`${backendUrl}/session`,{method:"POST"});if(!t.ok)throw new Error("session endpoint failed");const e=await t.json();if(ephemeralKey=e?.client_secret?.value||e?.ephemeralKey,realtimeUrl=e?.realtime_url||realtimeUrl,!ephemeralKey)throw new Error("no ephemeral key returned");localStream=await navigator.mediaDevices.getUserMedia({audio:!0}),pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});for(const t of localStream.getAudioTracks())pc.addTrack(t,localStream);pc.ontrack=t=>{t.streams&&t.streams[0]&&(assistantAudio.srcObject=t.streams[0],assistantAudio.play().catch((t=>console.warn("play error",t))))};pc.createDataChannel("oai-events").onmessage=t=>{try{const e=JSON.parse(t.data);"response.delta"===e.type?transcriptEl.textContent=e.delta?.content||e.delta?.text||JSON.stringify(e.delta):"transcript.delta"===e.type&&(transcriptEl.textContent=e.delta?.text||transcriptEl.textContent)}catch(e){transcriptEl.textContent=t.data}};const a=await pc.createOffer();await pc.setLocalDescription(a);const n=encodeURIComponent("gpt-4o-realtime-preview-2024-12-17");let o;const r=await fetch(`${realtimeUrl}?model=${n}`,{method:"POST",headers:{Authorization:`Bearer ${ephemeralKey}`,"Content-Type":"application/sdp"},body:pc.localDescription.sdp});if(!r.ok)throw new Error("Failed to get SDP");o=await r.text(),await pc.setRemoteDescription({type:"answer",sdp:o}),statusEl.textContent="කතාබස් සක්‍රීයයි"}catch(t){console.error(t),statusEl.textContent="සම්බන්ධතාවය අසාර්ථකයි",micActive=!1,micButton.classList.remove("active")}}function stopCall(){micActive=!1,pc&&(pc.getSenders().forEach((t=>t.track?.stop())),pc.close(),pc=null),localStream&&(localStream.getTracks().forEach((t=>t.stop())),localStream=null),ephemeralKey=null,assistantAudio.srcObject=null,statusEl.textContent="වෙළඳාම නැවත සක්‍රීයයි",transcriptEl.textContent="කතා අසනවා..."}micButton.addEventListener("click",(()=>{micActive?stopCall():startCall(),micButton.classList.toggle("active")})),window.addEventListener("beforeunload",(()=>{stopCall()}));