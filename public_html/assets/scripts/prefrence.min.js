document.addEventListener('DOMContentLoaded', function () {

    const API_URL = 'https://apilageai.lk/profileedit.php';

    // --- Elements ---
    const sidebarUserInfo = document.getElementById('sidebarUserInfo');
    const preferenceboxOverlay = document.getElementById('preferenceboxOverlay');
    const preferenceboxCloseBtn = document.getElementById('preferenceboxCloseBtn');
    const tabLinks = document.querySelectorAll('.preferencebox-tab-link');
    const tabContents = document.querySelectorAll('.preferencebox-tab-content');

    const changePhotoBtn = document.getElementById('changePhotoBtn');
    const profilePhotoInput = document.getElementById('profilePhotoInput');
    const saveGeneralBtn = document.getElementById('saveGeneralBtn');
    const savePreferenceBtn = document.getElementById('savePreferenceBtn');
    const clearMemoryBtn = document.getElementById('clearMemoryBtn');
    const currentMemoryBox = document.getElementById('currentMemoryBox');
    const generalAlertBox = document.getElementById('generalAlertBox');
    const preferenceAlertBox = document.getElementById('preferenceAlertBox');
    const billingHistoryBody = document.getElementById('billingHistoryBody');

    const schoolInput = document.getElementById('schoolInput');
    const notStudentInput = document.getElementById('notStudentInput');

    const profileLoader = document.getElementById('profileLoader'); // Loader element

    // --- Open/Close Lightbox ---
    sidebarUserInfo.addEventListener('click', () => {
        preferenceboxOverlay.style.display = 'flex';
    });

    preferenceboxCloseBtn.addEventListener('click', () => {
        preferenceboxOverlay.style.display = 'none';
    });

    preferenceboxOverlay.addEventListener('click', (event) => {
        if (event.target === preferenceboxOverlay) {
            preferenceboxOverlay.style.display = 'none';
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && preferenceboxOverlay.style.display === 'flex') {
            preferenceboxOverlay.style.display = 'none';
        }
    });

    // --- Tab Switching Logic ---
    tabLinks.forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const tabId = link.getAttribute('data-tab');

            tabLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            tabContents.forEach(content => {
                if (content.id === tabId) content.classList.add('active');
                else content.classList.remove('active');
            });
        });
    });

    // --- Profile Photo Upload Trigger ---
    if (changePhotoBtn && profilePhotoInput) {
        changePhotoBtn.addEventListener('click', () => {
            profilePhotoInput.click();
        });
    }
    // --- Loader when uploading profile photo ---
    if (profilePhotoInput) {
        profilePhotoInput.addEventListener('change', () => {
            // If a file is selected, show loader
            if (profilePhotoInput.files && profilePhotoInput.files.length > 0) {
                if (profileLoader) profileLoader.style.display = 'inline-block';
            }
        });
    }

    // --- Load all saved data ---
    async function loadProfileData() {
        try {
            const res = await fetch(`${API_URL}?action=load`);
            const data = await res.json();
            if (!data.success) return;

            // --- Load General Info ---
            if (data.user) {
                if (document.getElementById('firstName')) document.getElementById('firstName').value = data.user.first_name || '';
                if (document.getElementById('lastName')) document.getElementById('lastName').value = data.user.last_name || '';
                if (document.getElementById('email')) document.getElementById('email').value = data.user.email || '';
                if (document.getElementById('phone')) document.getElementById('phone').value = data.user.phone || '';
            }

            // --- Load Preferences ---
            if (schoolInput) schoolInput.value = data.school || '';
            if (notStudentInput) notStudentInput.checked = data.not_student == 1;

            if (data.interests && Array.isArray(data.interests)) {
                data.interests.forEach(subject => {
                    const checkbox = document.querySelector(`input[name="subjects"][value="${subject}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            if (data.preference) {
                const toneRadio = document.querySelector(`input[name="aiTone"][value="${data.preference}"]`);
                if (toneRadio) toneRadio.checked = true;
            }

            // --- Load Memory ---
            if (currentMemoryBox) {
                currentMemoryBox.textContent = data.user.memory || 'No memory stored.';
            }

  // --- Load Billing History ---
if (billingHistoryBody && Array.isArray(data.billing)) {
    billingHistoryBody.innerHTML = '';

    // Check if any transaction has a status_indicator
    const hasStatus = data.billing.some(tx => tx.status_indicator && tx.status_indicator.trim() !== '');

    data.billing.forEach(tx => {
        const tr = document.createElement('tr');

        // Create Download Receipt button
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = 'Download Receipt';
        downloadBtn.style.padding = '5px 10px';
        downloadBtn.style.cursor = 'pointer';

        // Function to generate PDF receipt
        downloadBtn.addEventListener('click', () => {
            // Ensure jsPDF 3.x is loaded and destructure jsPDF from window.jspdf
            if (!(window.jspdf && window.jspdf.jsPDF)) {
                alert('jsPDF library is not loaded.');
                return;
            }
            // Use destructuring to get jsPDF from window.jspdf
            const { jsPDF } = window.jspdf;
            if (typeof jsPDF !== 'function') {
                alert('jsPDF library is not available.');
                return;
            }
            const doc = new jsPDF();

            // Add logo
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = 'https://apilageai.lk/assets/images/logos/paylog.png';
            img.onload = function () {
                const imgWidth = 50;
                const imgHeight = (img.height * imgWidth) / img.width;
                doc.addImage(img, 'PNG', 80, 10, imgWidth, imgHeight);

                // Add invoice details
                doc.setFontSize(16);
                doc.text('Invoice Receipt', 105, 40, null, null, 'center');

                doc.setFontSize(12);
                doc.text(`Invoice ID: ${tx.invoice_id}`, 20, 60);
                doc.text(`Amount: Rs. ${tx.amount}`, 20, 70);
                doc.text(`Date: ${tx.created_at}`, 20, 80);
                const statusText = tx.status_indicator ? 'SUCCESS' : 'FAILED';
                doc.text(`Status: ${statusText}`, 20, 90);

                doc.save(`Invoice_${tx.invoice_id}.pdf`);
            };
            img.onerror = function () {
                alert('Failed to load logo image for receipt.');
            };
        });

        tr.innerHTML = `
            <td>${tx.invoice_id}</td>
            <td>Rs. ${tx.amount}</td>
            <td>${tx.created_at}</td>
            ${hasStatus ? `<td>${tx.status_indicator ? 'SUCCESS' : ''}</td>` : ''}
        `;
        const td = document.createElement('td');
        td.appendChild(downloadBtn);
        tr.appendChild(td);

        billingHistoryBody.appendChild(tr);
    });

    // Optionally, hide the table header for the Status column
    const statusHeader = document.querySelector('#billingTable thead th.statusColumn');
    if (statusHeader) {
        statusHeader.style.display = hasStatus ? '' : 'none';
    }
}

        } catch (err) {
            console.error('Error loading profile data', err);
        }
    }

    loadProfileData();

    // --- Save General Settings ---
    if (saveGeneralBtn) {
        saveGeneralBtn.addEventListener('click', async () => {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const photoFile = profilePhotoInput ? profilePhotoInput.files[0] : null;

            const formData = new FormData();
            formData.append('action', 'general');
            formData.append('firstName', firstName);
            formData.append('lastName', lastName);
            formData.append('email', email);
            formData.append('phone', phone);
            if (photoFile) formData.append('profilePhoto', photoFile);

            try {
                if (profileLoader) profileLoader.style.display = 'inline-block';
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (profileLoader) profileLoader.style.display = 'none';

                if (result.success) {
                    generalAlertBox.style.display = 'block';
                    generalAlertBox.style.color = 'green';
                    generalAlertBox.textContent = 'Profile updated successfully!';
                    loadProfileData();
                } else {
                    generalAlertBox.style.display = 'block';
                    generalAlertBox.style.color = 'red';
                    generalAlertBox.textContent = 'Failed: ' + result.message;
                }
            } catch (err) {
                if (profileLoader) profileLoader.style.display = 'none';
                generalAlertBox.style.display = 'block';
                generalAlertBox.style.color = 'red';
                generalAlertBox.textContent = 'Failed to update profile.';
                console.error(err);
            }
        });
    }

    // --- Save Preferences ---
    if (savePreferenceBtn) {
        savePreferenceBtn.addEventListener('click', async () => {
            const subjectBoxes = document.querySelectorAll('input[name="subjects"]:checked');
            const aiToneRadio = document.querySelector('input[name="aiTone"]:checked');
            const schoolVal = schoolInput ? schoolInput.value.trim() : '';
            const notStudentVal = notStudentInput ? (notStudentInput.checked ? 1 : 0) : 0;

            // Enforce only one of school or not_student can be selected
            if (schoolVal && notStudentVal) {
                preferenceAlertBox.style.display = 'block';
                preferenceAlertBox.style.color = 'red';
                preferenceAlertBox.textContent = "Select either School or Not a Student, not both.";
                return;
            }
            if (!schoolVal && !notStudentVal) {
                preferenceAlertBox.style.display = 'block';
                preferenceAlertBox.style.color = 'red';
                preferenceAlertBox.textContent = "Select your School or check Not a Student.";
                return;
            }

            if (subjectBoxes.length === 0) {
                preferenceAlertBox.style.display = 'block';
                preferenceAlertBox.style.color = 'red';
                preferenceAlertBox.textContent = 'Select at least one interested subject.';
                return;
            }

            if (!aiToneRadio) {
                preferenceAlertBox.style.display = 'block';
                preferenceAlertBox.style.color = 'red';
                preferenceAlertBox.textContent = 'Select an AI tone.';
                return;
            }

            const subjects = Array.from(subjectBoxes).map(cb => cb.value);

            const formData = new FormData();
            formData.append('action', 'preferences');
            formData.append('subjects', JSON.stringify(subjects));
            formData.append('aiTone', aiToneRadio.value);
            formData.append('school', schoolVal);
            formData.append('not_student', notStudentVal);

            try {
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    preferenceAlertBox.style.display = 'block';
                    preferenceAlertBox.style.color = 'green';
                    preferenceAlertBox.textContent = 'Preferences saved successfully!';
                    loadProfileData();
                } else {
                    preferenceAlertBox.style.display = 'block';
                    preferenceAlertBox.style.color = 'red';
                    preferenceAlertBox.textContent = 'Failed: ' + result.message;
                }
            } catch (err) {
                preferenceAlertBox.style.display = 'block';
                preferenceAlertBox.style.color = 'red';
                preferenceAlertBox.textContent = 'Failed to save preferences.';
                console.error(err);
            }
        });
    }

    // --- Enforce school / not_student exclusivity in UI ---
    if (schoolInput && notStudentInput) {
        // When typing in school, uncheck not_student if not empty
        schoolInput.addEventListener('input', () => {
            if (schoolInput.value.trim() !== '') {
                notStudentInput.checked = false;
            }
        });
        // When checking not_student, clear school input
        notStudentInput.addEventListener('change', () => {
            if (notStudentInput.checked) {
                schoolInput.value = '';
            }
        });
    }

    // --- Clear Memory ---
    if (clearMemoryBtn) {
        clearMemoryBtn.addEventListener('click', async () => {
            const formData = new FormData();
            formData.append('action', 'clearmemory');

            try {
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    currentMemoryBox.textContent = 'No memory stored.';
                    alert('Memory cleared successfully!');
                } else {
                    alert('Failed to clear memory: ' + result.message);
                }
            } catch (err) {
                alert('Error clearing memory.');
                console.error(err);
            }
        });
    }

    // --- Billing Slider Logic ---
    const priceRange = document.getElementById('priceRange');
    const priceDisplay = document.getElementById('priceDisplay');
    const payButton = document.getElementById('payButton');

    if (priceRange && priceDisplay && payButton) {
        priceRange.addEventListener('input', () => {
            const amount = priceRange.value;
            priceDisplay.textContent = `Rs. ${amount}`;
            payButton.textContent = `Pay Rs. ${amount}`;
        });

        payButton.addEventListener('click', () => {
            const amount = priceRange.value;
            window.location.href = `https://apilageai.lk/pay/${amount}`;
        });
    }

});


// Preference tab: Enforce either School or Not a student, not both
document.addEventListener('DOMContentLoaded', function() {
  const schoolInput = document.getElementById('schoolInput');
  const notStudentInput = document.getElementById('notStudentInput');
  if (schoolInput && notStudentInput) {
    // When user types in school, uncheck notStudent if not empty
    schoolInput.addEventListener('input', function() {
      if (schoolInput.value.trim() !== '') {
        notStudentInput.checked = false;
        notStudentInput.disabled = true;
      } else {
        notStudentInput.disabled = false;
      }
    });
    // When user checks notStudent, clear and disable school
    notStudentInput.addEventListener('change', function() {
      if (notStudentInput.checked) {
        schoolInput.value = '';
        schoolInput.disabled = true;
      } else {
        schoolInput.disabled = false;
      }
    });
    // On load, set correct state
    if (notStudentInput.checked) {
      schoolInput.value = '';
      schoolInput.disabled = true;
    }
    if (schoolInput.value.trim() !== '') {
      notStudentInput.checked = false;
      notStudentInput.disabled = true;
    }
  }
});