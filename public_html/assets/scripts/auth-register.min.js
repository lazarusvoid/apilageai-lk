document.addEventListener('DOMContentLoaded', function () {
    // Profile picture upload
    const profilePicture = document.getElementById('profilePicture');
    const profilePreview = document.getElementById('profilePreview');

    if (profilePicture && profilePreview) {
        profilePicture.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    profilePreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Password visibility toggle
    const togglePassword = document.getElementById('togglePassword');
    const password = document.getElementById('password');

    if (togglePassword && password) {
        togglePassword.addEventListener('click', function () {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            togglePassword.innerHTML = type === 'password' ?
                '<i class="fa-regular fa-eye"></i>' :
                '<i class="fa-regular fa-eye-slash"></i>';
        });
    }

    // Confirm password visibility toggle
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const confirmPassword = document.getElementById('confirmPassword');

    if (toggleConfirmPassword && confirmPassword) {
        toggleConfirmPassword.addEventListener('click', function () {
            const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPassword.setAttribute('type', type);
            toggleConfirmPassword.innerHTML = type === 'password' ?
                '<i class="fa-regular fa-eye"></i>' :
                '<i class="fa-regular fa-eye-slash"></i>';
        });
    }

    // Password rules check
    const ruleLength = document.getElementById('ruleLength');
    const ruleUpper = document.getElementById('ruleUpper');
    const ruleLower = document.getElementById('ruleLower');
    const ruleNumber = document.getElementById('ruleNumber');
    const ruleSpecial = document.getElementById('ruleSpecial');
    const submitBtn = document.querySelector('#signupForm button[type="submit"]');

    if (password && submitBtn) {
        password.addEventListener('input', function () {
            const value = password.value;

            const isLong = value.length >= 8;
            const hasUpper = /[A-Z]/.test(value);
            const hasLower = /[a-z]/.test(value);
            const hasNumber = /[0-9]/.test(value);
            const hasSpecial = /[^A-Za-z0-9]/.test(value);

            updateRule(ruleLength, isLong);
            updateRule(ruleUpper, hasUpper);
            updateRule(ruleLower, hasLower);
            updateRule(ruleNumber, hasNumber);
            updateRule(ruleSpecial, hasSpecial);

            const allValid = isLong && hasUpper && hasLower && hasNumber && hasSpecial;
            submitBtn.disabled = !allValid;
        });
    }

    function updateRule(element, condition) {
        if (condition) {
            element.classList.add('valid');
        } else {
            element.classList.remove('valid');
        }
    }

    // Form validation and submission
    const signupForm = document.getElementById('signupForm');
    const loadingOverlay = document.getElementById('loadingOverlay');

    if (signupForm) {
        signupForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const phone = document.getElementById('phone');
            const phoneRegex = /^\+?[0-9]{10,15}$/;

            const value = password.value;
            const isLong = value.length >= 8;
            const hasUpper = /[A-Z]/.test(value);
            const hasLower = /[a-z]/.test(value);
            const hasNumber = /[0-9]/.test(value);
            const hasSpecial = /[^A-Za-z0-9]/.test(value);
            const allValid = isLong && hasUpper && hasLower && hasNumber && hasSpecial;

            // Get reCAPTCHA response
            const captchaResponse = grecaptcha.getResponse();
            if (!captchaResponse) {
                new Dialog('Error', 'Please complete the reCAPTCHA verification', {
                    text: 'Okay', action: () => { }, color: '#ff3333'
                });
                return;
            }

            if (!phoneRegex.test(phone.value.replace(/\s/g, ''))) {
                new Dialog('Error', 'Please enter a valid phone number (10-15 digits)', {
                    text: 'Okay', action: () => { }, color: '#ff3333'
                });
                return;
            }

            if (!allValid) {
                new Dialog('Error', 'Password does not meet all requirements.', {
                    text: 'Okay', action: () => { }, color: '#ff3333'
                });
                return;
            }

            if (confirmPassword.value !== password.value) {
                new Dialog('Error', 'Passwords do not match', {
                    text: 'Okay', action: () => { }, color: '#ff3333'
                });
                return;
            }

            loadingOverlay.style.display = 'block';

            const data = new FormData(signupForm);
            data.append('captcha', captchaResponse);

            fetch('https://apilageai.lk/api/auth/register', {
                method: 'POST',
                body: data
            })
                .then(response => response.json())
                .then(data => {
                    loadingOverlay.style.display = 'none';

                    if (data.e) {
                        new Dialog('Error', data.m, {
                            text: 'Okay', action: () => { }, color: '#ff3333'
                        });
                        grecaptcha.reset();
                    } else {
                        // Check if email verification is required
                        if (data.verify_required && data.email) {
                            showRegistrationSuccessModal(data.email);
                        } else {
                            // Fallback to old behavior
                            new Dialog('Success', data.m, {
                                text: 'Continue', action: () => {
                                    window.location.href = 'https://apilageai.lk/auth/login';
                                }, color: '#28a745'
                            });
                        }
                    }
                })
                .catch(error => {
                    loadingOverlay.style.display = 'none';
                    console.error('Registration error:', error);
                    new Dialog('Error', 'Registration failed. Please try again.', {
                        text: 'Retry', action: () => { }, color: '#ff3333'
                    });
                    grecaptcha.reset();
                });
        });
    }
});

// Show registration success modal
function showRegistrationSuccessModal(email) {
    const modal = document.getElementById('registrationSuccessModal');
    const emailDisplay = document.getElementById('registeredEmail');
    
    if (modal && emailDisplay) {
        emailDisplay.textContent = email;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    } else {
        // Fallback
        alert('Registration successful! Please check ' + email + ' to verify your account.');
        setTimeout(() => {
            window.location.href = 'https://apilageai.lk/auth/login';
        }, 2000);
    }
}

// Close success modal
function closeSuccessModal() {
    const modal = document.getElementById('registrationSuccessModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }
    window.location.href = 'https://apilageai.lk/auth/login';
}

// Resend verification email from modal
function resendFromSuccessModal() {
    const email = document.getElementById('registeredEmail').textContent;
    const btn = document.getElementById('resendEmailBtn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';

    fetch('https://apilageai.lk/auth/resend-verification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'email=' + encodeURIComponent(email)
    })
    .then(res => res.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.e) {
            new Dialog('Error', data.m, {
                text: 'Okay', action: () => { }, color: '#ff3333'
            });
        } else {
            new Dialog('Success', 'Verification email sent successfully! Please check your inbox.', {
                text: 'Okay', action: () => { }, color: '#28a745'
            });
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        console.error('Resend error:', err);
        new Dialog('Error', 'Failed to resend email. Please try again.', {
            text: 'Okay', action: () => { }, color: '#ff3333'
        });
    });
}