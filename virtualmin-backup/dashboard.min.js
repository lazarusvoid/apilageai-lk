document.addEventListener('DOMContentLoaded', () => {
  const gallery = document.querySelector('#image-gallery .image-grid');
  const searchInput = document.getElementById('search-input');
  const navLinks = document.querySelectorAll('[data-tab]');
  const sidebarToggle = document.getElementById('sidebar-toggle');
  const mainContainer = document.querySelector('.main-container');
  const themeToggle = document.getElementById('theme-toggle');
  const themeIcon = document.getElementById('theme-icon');
  const modalOverlay = document.createElement('div');
  modalOverlay.className = 'modal-overlay';
  document.body.appendChild(modalOverlay);
  const docEl = document.documentElement;
  let currentTab = 'explore';

  // ‚úÖ Theme
  const saved = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = saved || (prefersDark ? 'dark' : 'light');
  docEl.setAttribute('data-theme', theme);
  themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  themeToggle.addEventListener('click', () => {
    const newTheme = docEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    docEl.setAttribute('data-theme', newTheme);
    themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    localStorage.setItem('theme', newTheme);
  });

  // ‚úÖ Sidebar toggle
  sidebarToggle.addEventListener('click', () => {
    mainContainer.classList.toggle('sidebar-minimized');
    const icon = sidebarToggle.querySelector('i');
    icon.className = mainContainer.classList.contains('sidebar-minimized')
      ? 'fas fa-chevron-right'
      : 'fas fa-chevron-left';
  });

  // ‚úÖ Fetch Helpers
  async function fetchImages(tab) {
    const endpoint =
      tab === 'friends'
        ? 'https://apilageai.lk/public_images.php'
        : 'https://apilageai.lk/images.php';
    const res = await fetch(endpoint, { credentials: 'include' });
    const data = await res.json();
    return data.images || [];
  }

  async function reactImage(id, type) {
    const res = await fetch(`https://apilageai.lk/react_image.php?id=${id}&type=${type}`, {
      credentials: 'include'
    });
    return await res.json();
  }

  async function togglePublic(id, makePublic) {
    const res = await fetch(
      `https://apilageai.lk/update_image_public.php?id=${id}&public=${makePublic ? 1 : 0}`,
      { credentials: 'include' }
    );
    return await res.json();
  }

  async function deleteImage(id) {
    const res = await fetch(`https://apilageai.lk/delete_image.php?id=${id}`, {
      credentials: 'include'
    });
    return await res.json();
  }

  // ‚úÖ Render Gallery
  async function loadImages(tab = 'explore') {
    gallery.innerHTML = '<p style="text-align:center;">Loading...</p>';
    const images = await fetchImages(tab);
    gallery.innerHTML = '';

    if (!images || !images.length) {
      gallery.innerHTML = '<p style="text-align:center;">No images found Ask apilageai to genarte some image and click publish on CHAT page</p>';
      return;
    }

    images.forEach(img => {
      const wrap = document.createElement('div');
      wrap.className = 'image-wrapper';
      wrap.innerHTML = `
        <img src="${img.image_url}" alt="Image" class="gallery-image" data-id="${img.id}" data-url="${img.image_url}" data-prompt="${img.prompt || ''}" data-author="${img.author_name || 'Unknown'}" data-likes="${img.likes}" data-unlikes="${img.unlikes}" />
        <div class="image-overlay">
          <p class="prompt">${(img.prompt || '').split(' ').slice(0, 10).join(' ')}...</p>
          ${
            tab === 'friends'
              ? `
              <div class="like-box">
                <button class="like-btn" data-id="${img.id}">
                  <i class="fas fa-heart"></i> <span>${img.likes}</span>
                </button>
                <button class="unlike-btn" data-id="${img.id}">
                  <i class="fas fa-thumbs-down"></i> <span>${img.unlikes}</span>
                </button>
              </div>`
              : `
              <div class="owner-actions">
                <span>‚ù§Ô∏è ${img.likes}</span> <span>üíî ${img.unlikes}</span>
                <button class="pub-btn" data-id="${img.id}" data-public="${img.public}">
                  ${img.public == 1 ? 'Unpublish' : 'Publish'}
                </button>
                <button class="del-btn" data-id="${img.id}">Delete</button>
              </div>`
          }
        </div>`;
      gallery.appendChild(wrap);
    });
  }

  // ‚úÖ Nav Tab Switch
  navLinks.forEach(l => {
    l.addEventListener('click', e => {
      e.preventDefault();
      navLinks.forEach(x => x.classList.remove('active'));
      l.classList.add('active');
      currentTab = l.dataset.tab;
      loadImages(currentTab);
    });
  });

  // ‚úÖ Modal Viewer
  function openModal(imgEl) {
    const imgSrc = imgEl.dataset.url;
    const prompt = imgEl.dataset.prompt;
    const author = imgEl.dataset.author;
    const likes = imgEl.dataset.likes;
    const unlikes = imgEl.dataset.unlikes;

    modalOverlay.innerHTML = `
      <div class="modal-container active">
        <div class="modal-content">
          <button class="modal-close-btn">&times;</button>
          <img src="${imgSrc}" class="modal-full-image" />
          <div class="modal-info">
            <p class="modal-prompt">${prompt}</p>
            <p class="modal-author">By: ${author}</p>
            <div class="modal-stats">
              <span>‚ù§Ô∏è ${likes}</span>
              <span>üíî ${unlikes}</span>
            </div>
            <div class="modal-actions">
              <button class="modal-btn" id="copy-url"><i class="fas fa-link"></i> Copy URL</button>
              <button class="modal-btn" id="share-img"><i class="fas fa-share-alt"></i> Share</button>
              <a class="modal-btn primary" id="download-img" href="${imgSrc}" download><i class="fas fa-download"></i> Download</a>
            </div>
          </div>
        </div>
      </div>`;
    modalOverlay.classList.add('active');
    document.body.classList.add('modal-open');

    modalOverlay.querySelector('.modal-close-btn').addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', e => {
      if (e.target === modalOverlay) closeModal();
    });

    modalOverlay.querySelector('#copy-url').addEventListener('click', () => {
      navigator.clipboard.writeText(imgSrc);
      alert('Image URL copied!');
    });

    modalOverlay.querySelector('#share-img').addEventListener('click', async () => {
      if (navigator.share) {
        await navigator.share({ title: 'Apilage AI Image', text: prompt, url: imgSrc });
      } else alert('Share not supported on this device.');
    });
  }

  function closeModal() {
    modalOverlay.classList.remove('active');
    document.body.classList.remove('modal-open');
    modalOverlay.innerHTML = '';
  }

  // ‚úÖ Like, Unlike, Publish, Delete, and Modal open
  gallery.addEventListener('click', async e => {
    const imgEl = e.target.closest('.gallery-image');
    const like = e.target.closest('.like-btn');
    const unlike = e.target.closest('.unlike-btn');
    const pub = e.target.closest('.pub-btn');
    const del = e.target.closest('.del-btn');

    if (imgEl) {
      openModal(imgEl);
    }

    if (like) {
      const res = await reactImage(like.dataset.id, 'like');
      if (res.success) {
        like.querySelector('span').textContent = res.likes;
        const unlikeBtn = gallery.querySelector(`.unlike-btn[data-id="${like.dataset.id}"]`);
        if (unlikeBtn) unlikeBtn.querySelector('span').textContent = res.unlikes;
        like.classList.toggle('active');
        if (unlikeBtn) unlikeBtn.classList.remove('active');
      }
    }

    if (unlike) {
      const res = await reactImage(unlike.dataset.id, 'unlike');
      if (res.success) {
        unlike.querySelector('span').textContent = res.unlikes;
        const likeBtn = gallery.querySelector(`.like-btn[data-id="${unlike.dataset.id}"]`);
        if (likeBtn) likeBtn.querySelector('span').textContent = res.likes;
        unlike.classList.toggle('active');
        if (likeBtn) likeBtn.classList.remove('active');
      }
    }

    if (pub) {
      const id = pub.dataset.id;
      const val = pub.dataset.public === '0';
      const res = await togglePublic(id, val);
      if (res.success) {
        pub.textContent = val ? 'Unpublish' : 'Publish';
        pub.dataset.public = val ? '1' : '0';
      }
    }

    if (del) {
      if (confirm('Delete this image?')) {
        const res = await deleteImage(del.dataset.id);
        if (res.success) del.closest('.image-wrapper').remove();
      }
    }
  });

  // ‚úÖ Search Filter
  searchInput.addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('.image-wrapper').forEach(w => {
      const text = w.querySelector('.prompt')?.textContent.toLowerCase() || '';
      w.style.display = text.includes(q) ? '' : 'none';
    });
  });

  loadImages();
});